<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#FFFFFF">
		<title>Pixiv Database Viewer</title>
		<link rel="stylesheet" href="./src/style.css">
        <link rel="manifest" href="./manifest.json">
        <link rel="apple-touch-icon" href="./src/icon.png">
		<script src="./src/jquery-3.6.0.min.js"></script>
		<script>
        function Search() {
            var File = new XMLHttpRequest();
            var content;
            File.open("GET", "https://jl93lol.github.io/pixiv/database/database0.txt", false);
            File.onreadystatechange = function ()
            {
                if(File.readyState === 4)
                {
                    if(File.status === 200 || File.status == 0)
                    {
                        content = File.responseText;
                    }
                }
            }
            File.send(null);
            
            var database = JSON.parse(content);

            var firstarray = true;
            var passfilter;
            var keyword = $(".searchbar").val().split(" ");
            var grid = $("#GridSize").val();
            var sort = $("#Sorting").val();
            var gridcount = 0;
            var resultcount = 0;
            var resultarray;

            for (let i in database) {

                if (keyword == "") {
                    passfilter = true;
                } else {
                    if (!document.getElementById("StrictSearch").checked) {
                        passfilter = false;
                        for (let i2 = 0; i2 < keyword.length && !passfilter; i2++) {
                            passfilter = true;

                            if (!document.getElementById("Everyone").checked) {
                                if (!database[i].tag0.includes("R-18")) {
                                    passfilter = false;
                                }
                            }

                            if (!document.getElementById("R-18").checked) {
                                if (database[i].tag0.includes("R-18")) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Artists").checked) {
                                if (!database[i].artist.includes(keyword[i2])) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Tags").checked) {
                                if (!(database[i].tag0.includes(keyword[i2]) || database[i].tag1.includes(keyword[i2]))) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("PID").checked) {
                                if (!database[i].id.includes(keyword[i2])) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Original").checked) {
                                if (!database[i].tag0.includes("原创")) {
                                    passfilter = false;
                                }
                            }
                        }
                    } else {
                        passfilter = true;
                        for (let i3 = 0; i3 < keyword.length && passfilter; i3++) {
                            if (!document.getElementById("Everyone").checked) {
                                if (!database[i].tag0.includes("R-18")) {
                                    passfilter = false;
                                }
                            }

                            if (!document.getElementById("R-18").checked) {
                                if (database[i].tag0.includes("R-18")) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Artists").checked) {
                                if (!database[i].artist.includes(keyword[i3])) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Tags").checked) {
                                if (!(database[i].tag0.includes(keyword[i3]) || database[i].tag1.includes(keyword[i3]))) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("PID").checked) {
                                if (!database[i].id.includes(keyword[i3])) {
                                    passfilter = false;
                                }
                            }

                            if (document.getElementById("Original").checked) {
                                if (!database[i].tag0.includes("原创")) {
                                    passfilter = false;
                                }
                            }
                        }
                    }
                    
                }

                if (passfilter) {
                    if (sort == 1) {
                        if (!firstarray) {
                            resultarray.unshift(database[i].id);
                        } else {
                            resultarray = [database[i].id];
                            firstarray = false;
                        }
                    } else {
                        if (!firstarray) {
                            resultarray.push(database[i].id);
                        } else {
                            resultarray = [database[i].id];
                            firstarray = false;
                        }
                    }
                }
            }

            var result = '<p class="debug"></p><div class="beautify">';
            for (let i4 = 0; i4 < resultarray.length; i4++) {
                for (let i5 in database) {
                    if (resultarray[i4] == database[i5].id) {
                        gridcount += 1;
                        resultcount += 1;
                        result += '<img class="gridimage" src="./preview/' + database[i5].id + '.jpg">';
                        if (gridcount >= grid) {
                            result += '</div><div class="beautify">';
                            gridcount = 0;
                        }
                    }
                }
            }
            result += "</div>";

            $("head").append('<style type="text/css"></style>');
            var styleElement = $("head").children(':last');
            styleElement.html('.gridimage{width:' + (98 - grid * 0.5) / grid + "vw" + ';height:' + (98 - grid * 0.5) / grid + "vw" + ';}');

            document.getElementsByClassName("main")[0].innerHTML = result;

            if (resultcount == 0) {
                document.getElementsByClassName("debug")[0].innerText = "No result.";
            } else {
                document.getElementsByClassName("debug")[0].innerText = resultcount + " artworks found.";
            }

            return false;
        }      
		</script>
	</head>
	
	<body>
        <ul class="nav">
            <form onsubmit="return Search();">
                <input type="text" class="searchbar" placeholder="Search...">
            </form>
            <div>
                <input id="menutoggle" type="checkbox" />
                <label class="menubtn" for="menutoggle">
                    <span></span>
                </label>
            
                <ul class="menubox">
                    <h1 class="menutitle">Pixiv Database Viewer v1.1</h1>
                    <p class="menuauthor">By Jimmy Leung</p><br>

                    <h2 class="menutitle">General</h2>

                    <span class="menuinfo">Grid size</span>
                    <input type="number" id="GridSize" value="3" min="1"><br>

                    <span class="menuinfo">Sort by</span>
                    <select id="Sorting">
                        <option value="1">Time (descending)</option>
                        <option value="2">Time (ascending)</option>
                    </select><br>

                    <span class="menuinfo">Smart search</span>
                    <label class="switch">
                        <input type="checkbox" id="SmartSearch" disabled>
                        <span class="slider"></span>
                    </label><br>

                    <span class="menuinfo">Strict search</span>
                    <label class="switch">
                        <input type="checkbox" id="StrictSearch" checked>
                        <span class="slider"></span>
                    </label><br>

                    <h2 class="menutitle">Age restrictions</h2>
                    
                    <span class="menuinfo">Everyone</span>
                    <label class="switch">
                        <input type="checkbox" id="Everyone" checked>
                        <span class="slider"></span>
                    </label><br>

                    <span class="menuinfo">R-18</span>
                    <label class="switch">
                        <input type="checkbox" id="R-18" checked>
                        <span class="slider"></span>
                    </label><br>

                    <h2 class="menutitle">Search for</h2>

                    <span class="menuinfo">Artists</span>
                    <label class="switch">
                        <input type="checkbox" id="Artists">
                        <span class="slider"></span>
                    </label><br>

                    <span class="menuinfo">Tags</span>
                    <label class="switch">
                        <input type="checkbox" id="Tags" checked>
                        <span class="slider"></span>
                    </label><br>

                    <span class="menuinfo">Pixiv ID</span>
                    <label class="switch">
                        <input type="checkbox" id="PID">
                        <span class="slider"></span>
                    </label><br>

                    <h2 class="menutitle">Type</h2>

                    <span class="menuinfo">Original</span>
                    <label class="switch">
                        <input type="checkbox" id="Original">
                        <span class="slider"></span>
                    </label><br>
                    
                    <a class="applybtn" href='javascript:$("#menutoggle").click();Search();'>Apply filter</a><br><br><br><br>
                </ul>
            </div>
        </ul>

        <div class="main">
            
        </div>
    </body>